---
description: Rules for developing Cycloid MCP components using FastMCP 3.0 function-based architecture
globs: src/components/**/*.py,tests/test_*_component.py
---

# Cycloid MCP Component Development Rules

## Component Architecture Overview

Components are **plain async functions** in `src/components/`, auto-discovered by `FileSystemProvider`. No classes, no inheritance — just decorated functions with dependency injection.

## Component Structure

Each component is a single file in `src/components/`:
```
src/components/
├── catalogs.py      # @tool + @resource functions
├── events.py        # @tool + @resource functions
├── pipelines.py     # @tool + @resource functions
├── stacks.py        # @tool + @resource + elicitation
└── stackforms.py    # @tool function
```

## Component Implementation Pattern

### Tool + Resource Template
```python
"""Feature tools and resources for Cycloid MCP server."""

import json
from typing import Any, Dict

from fastmcp.dependencies import Depends  # type: ignore[reportAttributeAccessIssue]
from fastmcp.exceptions import ToolError
from fastmcp.resources import resource
from fastmcp.tools import tool
from fastmcp.utilities.logging import get_logger

from src.cli import CLIMixin
from src.dependencies import get_cli
from src.exceptions import CycloidCLIError
from src.types import JSONList

logger = get_logger(__name__)


async def _get_items(cli: CLIMixin) -> JSONList:
    """Private helper — get items from CLI."""
    data = await cli.execute_cli("command", ["list"])
    return cli.process_cli_response(data, list_key="items")


@tool(
    name="CYCLOID_ITEM_LIST",
    description="List all items with their details.",
    annotations={"readOnlyHint": True},
)
async def list_items(
    cli: CLIMixin = Depends(get_cli),  # type: ignore[reportCallInDefaultInitializer]
) -> Dict[str, Any]:
    """List all items. Returns dict with items list and count."""
    try:
        items = await _get_items(cli)
        return {"items": items, "count": len(items)}
    except CycloidCLIError as e:
        raise ToolError(f"Failed to list items: {str(e)}")
    except Exception as e:
        raise ToolError(f"Error listing items: {str(e)}")


@resource("cycloid://items")
async def get_items_resource(
    cli: CLIMixin = Depends(get_cli),  # type: ignore[reportCallInDefaultInitializer]
) -> str:
    """Get all items as a resource."""
    try:
        items = await _get_items(cli)
        return json.dumps({"items": items, "count": len(items)}, indent=2)
    except CycloidCLIError as e:
        logger.error(f"Failed to read items resource: {str(e)}")
        return json.dumps({"error": str(e), "items": [], "count": 0}, indent=2)
```

## Creating New Components

1. Create a single file `src/components/[feature].py`
2. Add private helper functions (prefixed `_`)
3. Add `@tool` decorated async functions
4. Add `@resource` decorated async functions (optional)
5. **No server.py changes needed** — FileSystemProvider discovers automatically

## Key Rules

- **Tool naming**: `CYCLOID_[ENTITY]_[ACTION]` (e.g., `CYCLOID_PIPELINE_LIST`)
- **Resource URIs**: `cycloid://[entity-plural]` (e.g., `cycloid://pipelines`)
- **Return types**: Tools return `Dict[str, Any]` or `str`; Resources return `str` (JSON)
- **Read-only tools**: Add `annotations={"readOnlyHint": True}`
- **Error handling**: `ToolError` for tool errors, `CycloidCLIError` for CLI failures
- **No table formatting**: JSON-only output
- **Depends injection**: Always use `Depends(get_cli)` with type: ignore comments

## Testing Pattern

```python
import json
import pytest
from unittest.mock import MagicMock, patch
from fastmcp import Client, FastMCP
from src.components.feature import list_items, get_items_resource

@pytest.fixture
def feature_server():
    server = FastMCP("TestFeatureServer")
    server.add_tool(list_items)
    server.add_resource(get_items_resource)
    return server

@patch("src.components.feature.CLIMixin")
async def test_list_items(mock_cli_class, feature_server):
    mock_cli = MagicMock()
    mock_cli.execute_cli = AsyncMock(return_value=[{"name": "test"}])
    mock_cli.process_cli_response = MagicMock(return_value=[{"name": "test"}])
    mock_cli_class.return_value = mock_cli

    async with Client(feature_server) as client:
        result = await client.call_tool("CYCLOID_ITEM_LIST", {})
        data = json.loads(result.data[0].text)
        assert data["count"] == 1
```
