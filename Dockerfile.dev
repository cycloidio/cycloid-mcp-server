FROM python:3.12-alpine

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apk add --no-cache \
    git \
    curl \
    build-base \
    libffi-dev \
    openssl-dev

# Install uv
RUN pip install uv

# Copy source code first (so README.md is available)
COPY . .

# Install dependencies globally using uv
RUN uv pip install --system -e .

# Copy CLI installation script
COPY scripts/install_cli.sh /tmp/install_cli.sh
RUN chmod +x /tmp/install_cli.sh

# Install CLI as root (before creating non-root user)
RUN /tmp/install_cli.sh

# Create a non-root user
RUN adduser -D -u 1000 cycloid

# Fix permissions for the cycloid user
RUN chown -R cycloid:cycloid /app && \
    chmod -R 755 /app

USER cycloid

# Expose port for development server (if needed)
EXPOSE 8000

# Run server directly with Python
CMD ["python3", "server.py"] 